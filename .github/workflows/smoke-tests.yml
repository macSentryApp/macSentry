# Smoke Tests - Automated "happy path" validation on macOS
# Runs on GitHub Actions macOS runners to validate basic functionality

name: Smoke Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers
  schedule:
    # Run daily at 6 AM UTC to catch any macOS updates that break things
    - cron: '0 6 * * *'

permissions:
  contents: read

env:
  PYTHON_VERSION: '3.12'
  # Performance threshold in seconds (60s baseline for CI VMs)
  PERFORMANCE_THRESHOLD: 60

jobs:
  smoke-test:
    name: Smoke Test (${{ matrix.os }} / Python ${{ matrix.python-version }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        # Comprehensive macOS coverage:
        # - macos-13: Intel (x86_64) - Ventura
        # - macos-14: Apple Silicon (arm64) - Sonoma
        # - macos-15: Apple Silicon (arm64) - Sequoia
        os: [macos-13, macos-14, macos-15]
        python-version: ['3.10', '3.11', '3.12', '3.13']
        exclude:
          # Focus Python version testing on latest macOS, test oldest+newest on others
          - os: macos-13
            python-version: '3.11'
          - os: macos-13
            python-version: '3.13'
          - os: macos-14
            python-version: '3.11'
          - os: macos-14
            python-version: '3.13'
        include:
          # Explicitly include macos-latest to track GitHub's latest designation
          - os: macos-latest
            python-version: '3.12'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Display system info
        run: |
          echo "=== System Information ==="
          sw_vers
          uname -a
          python --version
          echo "Architecture: $(uname -m)"
          echo "CPU: $(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo 'Apple Silicon')"
          echo "Runner: ${{ matrix.os }}"
          echo "Processor count: $(sysctl -n hw.ncpu)"
          echo "Memory: $(sysctl -n hw.memsize | awk '{print $0/1024/1024/1024 " GB"}')"
          # Detect if running on Intel or Apple Silicon
          if [ "$(uname -m)" = "x86_64" ]; then
            echo "Platform: Intel (x86_64)"
          else
            echo "Platform: Apple Silicon (arm64)"
          fi

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-timeout

      - name: Verify project structure
        run: |
          echo "=== Project Structure Check ==="
          test -f src/macsentry/macos_security_audit.py || (echo "ERROR: Main script not found" && exit 1)
          test -d src/macsentry/checks || (echo "ERROR: checks directory not found" && exit 1)
          test -d src/macsentry/utils || (echo "ERROR: utils directory not found" && exit 1)
          test -d src/macsentry/core || (echo "ERROR: core directory not found" && exit 1)
          echo "‚úì All required files and directories present"

      - name: Run smoke tests
        run: |
          python -m pytest tests/test_smoke.py -v --tb=short --timeout=60
        env:
          SMOKE_TEST_PERFORMANCE_THRESHOLD: ${{ env.PERFORMANCE_THRESHOLD }}
          PYTHONPATH: src

      - name: Basic functionality check - Help
        run: |
          echo "=== Testing --help ==="
          python -m macsentry.cli --help
          echo "‚úì Help command works"
        env:
          PYTHONPATH: src

      - name: Basic functionality check - Dry run
        run: |
          echo "=== Testing --dry-run ==="
          python -m macsentry.cli --dry-run
          echo "‚úì Dry run works"
        env:
          PYTHONPATH: src

      - name: Basic functionality check - Text output
        run: |
          echo "=== Testing text output ==="
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          (python -m macsentry.cli --format text --verbose 2>&1 || true) | head -100
          echo "‚úì Text output works"
        env:
          PYTHONPATH: src

      - name: Basic functionality check - JSON output
        run: |
          echo "=== Testing JSON output ==="
          # Exit codes 0, 2, 3 are valid (0=pass, 2=issues found, 3=warnings)
          # Capture JSON output (stdout only), let stderr show in logs
          output=$(python -m macsentry.cli --format json 2>/dev/null) || exit_code=$?
          # Only fail on exit code 1 (actual error)
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          echo "$output" | python -c "import sys, json; json.load(sys.stdin)" && echo "‚úì Valid JSON output"
        env:
          PYTHONPATH: src

      - name: Basic functionality check - HTML output
        run: |
          echo "=== Testing HTML output ==="
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python -m macsentry.cli --format html --output /tmp/report.html || exit_code=$?
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          test -f /tmp/report.html && echo "‚úì HTML file created"
          grep -q "<html" /tmp/report.html && echo "‚úì HTML content valid"
        env:
          PYTHONPATH: src

      - name: Performance baseline check
        run: |
          echo "=== Performance Test ==="
          echo "Threshold: ${PERFORMANCE_THRESHOLD}s"
          arch=$(uname -m)
          echo "Architecture: $arch"
          start_time=$(python -c "import time; print(time.time())")
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python -m macsentry.cli --format json > /dev/null 2>&1 || true
          end_time=$(python -c "import time; print(time.time())")
          duration=$(python -c "print(round($end_time - $start_time, 2))")
          echo "Execution time: ${duration}s"
          
          # Check if within threshold - stricter on Apple Silicon
          python -c "
          import sys
          import subprocess
          duration = float('$duration')
          threshold = float('$PERFORMANCE_THRESHOLD')
          arch = '$arch'
          
          if duration > threshold:
              print(f'‚ö†Ô∏è WARNING: Execution time ({duration}s) exceeds threshold ({threshold}s)')
              # Fail on Apple Silicon (arm64), just warn on Intel (x86_64)
              if arch == 'arm64':
                  print('‚ùå FAIL: Apple Silicon should meet performance threshold')
                  sys.exit(1)
              else:
                  print('‚ö†Ô∏è Intel runner - warning only')
          else:
              print(f'‚úì Performance OK: {duration}s < {threshold}s threshold')
          "
        env:
          PYTHONPATH: src

      - name: Exit code validation
        run: |
          echo "=== Exit Code Test ==="
          python -m macsentry.cli --dry-run
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "‚úì Clean exit (code 0)"
          else
            echo "‚úó Unexpected exit code: $exit_code"
            exit 1
          fi
        env:
          PYTHONPATH: src

      - name: Category filter test
        run: |
          echo "=== Category Filter Test ==="
          python -m macsentry.cli --categories encryption --dry-run
          python -m macsentry.cli --categories firewall,privacy --dry-run
          echo "‚úì Category filtering works"
        env:
          PYTHONPATH: src

      - name: Severity filter test
        run: |
          echo "=== Severity Filter Test ==="
          python -m macsentry.cli --min-severity HIGH --dry-run
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python -m macsentry.cli --min-severity CRITICAL --format json > /dev/null || exit_code=$?
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          echo "‚úì Severity filtering works"
        env:
          PYTHONPATH: src

      - name: Architecture compatibility test
        run: |
          echo "=== Architecture Compatibility Test ==="
          arch=$(uname -m)
          echo "Testing on architecture: $arch"
          
          # Verify Python binary architecture matches system
          python_arch=$(python -c "import platform; print(platform.machine())")
          echo "Python architecture: $python_arch"
          
          if [ "$arch" != "$python_arch" ]; then
            echo "‚ö†Ô∏è WARNING: Architecture mismatch - may be running under Rosetta"
          else
            echo "‚úì Native architecture confirmed"
          fi
          
          # Test that all checks load correctly on this architecture
          PYTHONPATH=src python -c "
          from macsentry.checks import load_checks
          from macsentry.checks.base import CheckRegistry
          
          load_checks()
          checks = CheckRegistry.get_all()
          print(f'Loaded {len(checks)} checks on $(uname -m)')
          
          # Verify each check can be instantiated
          for cls in checks:
              try:
                  instance = cls()
                  print(f'  ‚úì {cls.name}')
              except Exception as e:
                  print(f'  ‚úó {cls.name}: {e}')
                  exit(1)
          
          print(f'‚úì All checks compatible with $(uname -m)')
          "

  # Architecture-specific deep tests (run on each architecture)
  architecture-tests:
    name: Architecture Deep Test (${{ matrix.runner }})
    runs-on: ${{ matrix.runner }}
    timeout-minutes: 15
    strategy:
      fail-fast: false
      matrix:
        include:
          # Intel x86_64 runner
          - runner: macos-13
            arch: x86_64
            arch_name: Intel
          # Apple Silicon arm64 runner
          - runner: macos-14
            arch: arm64
            arch_name: Apple Silicon

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Verify architecture
        run: |
          echo "=== Architecture Verification ==="
          expected_arch="${{ matrix.arch }}"
          actual_arch=$(uname -m)
          echo "Expected: $expected_arch"
          echo "Actual: $actual_arch"
          
          if [ "$expected_arch" != "$actual_arch" ]; then
            echo "‚ùå ERROR: Architecture mismatch!"
            exit 1
          fi
          echo "‚úì Running on expected ${{ matrix.arch_name }} (${{ matrix.arch }}) architecture"

      - name: Test macOS-specific system calls
        run: |
          echo "=== macOS System Calls Test ==="
          python3 << 'EOF'
          import subprocess
          import platform
          
          print(f'Platform: {platform.platform()}')
          print(f'Machine: {platform.machine()}')
          print(f'Processor: {platform.processor()}')
          
          # Test common macOS commands used by security checks
          commands = [
              ['sw_vers', '-productVersion'],
              ['system_profiler', 'SPSoftwareDataType'],
              ['defaults', 'read', '/Library/Preferences/com.apple.SoftwareUpdate', 'AutomaticCheckEnabled'],
              ['csrutil', 'status'],
              ['spctl', '--status'],
          ]
          
          for cmd in commands:
              try:
                  result = subprocess.run(cmd, capture_output=True, text=True, timeout=10)
                  status = '‚úì' if result.returncode == 0 else '‚ö†Ô∏è'
                  print(f'{status} {" ".join(cmd)}: exit code {result.returncode}')
              except Exception as e:
                  print(f'‚ö†Ô∏è {" ".join(cmd)}: {e}')
          
          print('‚úì System calls test completed')
          EOF

      - name: Run full audit on ${{ matrix.arch_name }}
        run: |
          echo "=== Full Audit on ${{ matrix.arch_name }} ==="
          # Run full audit and capture results
          exit_code=0
          python -m macsentry.cli --format json --output /tmp/audit_${{ matrix.arch }}.json || exit_code=$?
          
          # Check if audit produced output file
          if [ ! -f /tmp/audit_${{ matrix.arch }}.json ]; then
            echo "‚ùå ERROR: Audit failed to create output file (exit code: $exit_code)"
            echo "Checking if macsentry module is available..."
            python -c "import macsentry; print('macsentry module found')" || echo "macsentry module not found"
            exit 1
          fi
          
          # Only fail on exit code 1 (actual error), exit code 2 means security issues found (expected)
          if [ "$exit_code" -eq 1 ]; then
            echo "‚ùå ERROR: Audit failed with exit code 1"
            cat /tmp/audit_${{ matrix.arch }}.json 2>/dev/null || true
            exit 1
          fi
          
          # Parse and display results
          python3 << 'PARSE_EOF'
          import json
          import os
          
          json_file = '/tmp/audit_${{ matrix.arch }}.json'
          if os.path.exists(json_file):
              with open(json_file) as f:
                  data = json.load(f)
              print(f'Audit completed on ${{ matrix.arch_name }}')
              print(f'Total checks: {data.get("summary", {}).get("total_checks", "N/A")}')
              print(f'Passed: {data.get("summary", {}).get("passed", "N/A")}')
              print(f'Failed: {data.get("summary", {}).get("failed", "N/A")}')
          else:
              print('Warning: JSON output file not found')
          PARSE_EOF
          echo "‚úì Full audit completed on ${{ matrix.arch_name }}"
        env:
          PYTHONPATH: src

      - name: Upload architecture-specific results
        uses: actions/upload-artifact@v4
        with:
          name: audit-results-${{ matrix.arch }}
          path: /tmp/audit_${{ matrix.arch }}.json
          retention-days: 7

  # Summary job that reports overall status
  smoke-test-summary:
    name: Smoke Test Summary
    needs: [smoke-test, architecture-tests]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check smoke test results
        run: |
          echo "## Smoke Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Check smoke tests
          if [ "${{ needs.smoke-test.result }}" == "success" ]; then
            echo "‚úÖ **Smoke Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
            smoke_ok=true
          else
            echo "‚ùå **Smoke Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
            smoke_ok=false
          fi
          
          # Check architecture tests
          if [ "${{ needs.architecture-tests.result }}" == "success" ]; then
            echo "‚úÖ **Architecture Tests**: PASSED" >> $GITHUB_STEP_SUMMARY
            arch_ok=true
          else
            echo "‚ùå **Architecture Tests**: FAILED" >> $GITHUB_STEP_SUMMARY
            arch_ok=false
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Matrix Coverage" >> $GITHUB_STEP_SUMMARY
          echo "- **macOS Versions**: Ventura (13), Sonoma (14), Sequoia (15)" >> $GITHUB_STEP_SUMMARY
          echo "- **Architectures**: Intel (x86_64), Apple Silicon (arm64)" >> $GITHUB_STEP_SUMMARY
          echo "- **Python Versions**: 3.10, 3.11, 3.12, 3.13" >> $GITHUB_STEP_SUMMARY
          
          # Final result
          if [ "$smoke_ok" = true ] && [ "$arch_ok" = true ]; then
            echo ""
            echo "üéâ All tests passed across all macOS versions and architectures!"
            exit 0
          else
            echo ""
            echo "‚ùå Some tests failed - check individual job results"
            exit 1
          fi
