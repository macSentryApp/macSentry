# Smoke Tests - Automated "happy path" validation on macOS
# Runs on GitHub Actions macOS runners to validate basic functionality

name: Smoke Tests

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggers
  schedule:
    # Run daily at 6 AM UTC to catch any macOS updates that break things
    - cron: '0 6 * * *'

env:
  PYTHON_VERSION: '3.12'
  # Performance threshold in seconds (60s baseline for CI VMs)
  PERFORMANCE_THRESHOLD: 60

jobs:
  smoke-test:
    name: Smoke Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 20
    strategy:
      fail-fast: false
      matrix:
        os: [macos-latest, macos-14]  # macos-14 is M1/M2 (Apple Silicon)
        python-version: ['3.10', '3.11', '3.12']
        exclude:
          # Only test all Python versions on latest macOS
          - os: macos-14
            python-version: '3.10'
          - os: macos-14
            python-version: '3.11'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: 'pip'

      - name: Display system info
        run: |
          echo "=== System Information ==="
          sw_vers
          uname -a
          python --version
          echo "Architecture: $(uname -m)"
          echo "CPU: $(sysctl -n machdep.cpu.brand_string 2>/dev/null || echo 'Apple Silicon')"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-timeout

      - name: Verify project structure
        run: |
          echo "=== Project Structure Check ==="
          test -f macos_security_audit.py || (echo "ERROR: Main script not found" && exit 1)
          test -d checks || (echo "ERROR: checks directory not found" && exit 1)
          test -d utils || (echo "ERROR: utils directory not found" && exit 1)
          test -d core || (echo "ERROR: core directory not found" && exit 1)
          echo "✓ All required files and directories present"

      - name: Run smoke tests
        run: |
          python -m pytest tests/test_smoke.py -v --tb=short --timeout=60
        env:
          SMOKE_TEST_PERFORMANCE_THRESHOLD: ${{ env.PERFORMANCE_THRESHOLD }}

      - name: Basic functionality check - Help
        run: |
          echo "=== Testing --help ==="
          python macos_security_audit.py --help
          echo "✓ Help command works"

      - name: Basic functionality check - Dry run
        run: |
          echo "=== Testing --dry-run ==="
          python macos_security_audit.py --dry-run
          echo "✓ Dry run works"

      - name: Basic functionality check - Text output
        run: |
          echo "=== Testing text output ==="
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          (python macos_security_audit.py --format text --verbose 2>&1 || true) | head -100
          echo "✓ Text output works"

      - name: Basic functionality check - JSON output
        run: |
          echo "=== Testing JSON output ==="
          # Exit codes 0, 2, 3 are valid (0=pass, 2=issues found, 3=warnings)
          # Capture JSON output (stdout only), let stderr show in logs
          output=$(python macos_security_audit.py --format json 2>/dev/null) || exit_code=$?
          # Only fail on exit code 1 (actual error)
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          echo "$output" | python -c "import sys, json; json.load(sys.stdin)" && echo "✓ Valid JSON output"

      - name: Basic functionality check - HTML output
        run: |
          echo "=== Testing HTML output ==="
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python macos_security_audit.py --format html --output /tmp/report.html || exit_code=$?
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          test -f /tmp/report.html && echo "✓ HTML file created"
          grep -q "<html" /tmp/report.html && echo "✓ HTML content valid"

      - name: Performance baseline check
        run: |
          echo "=== Performance Test ==="
          echo "Threshold: ${PERFORMANCE_THRESHOLD}s"
          start_time=$(python -c "import time; print(time.time())")
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python macos_security_audit.py --format json > /dev/null 2>&1 || true
          end_time=$(python -c "import time; print(time.time())")
          duration=$(python -c "print(round($end_time - $start_time, 2))")
          echo "Execution time: ${duration}s"
          
          # Check if within threshold
          python -c "
          import sys
          duration = float('$duration')
          threshold = float('$PERFORMANCE_THRESHOLD')
          if duration > threshold:
              print(f'⚠️ WARNING: Execution time ({duration}s) exceeds threshold ({threshold}s)')
              # Don't fail on Intel Macs, just warn
              if '${{ matrix.os }}' == 'macos-14':
                  sys.exit(1)
          else:
              print(f'✓ Performance OK: {duration}s < {threshold}s threshold')
          "

      - name: Exit code validation
        run: |
          echo "=== Exit Code Test ==="
          python macos_security_audit.py --dry-run
          exit_code=$?
          if [ $exit_code -eq 0 ]; then
            echo "✓ Clean exit (code 0)"
          else
            echo "✗ Unexpected exit code: $exit_code"
            exit 1
          fi

      - name: Category filter test
        run: |
          echo "=== Category Filter Test ==="
          python macos_security_audit.py --categories encryption --dry-run
          python macos_security_audit.py --categories firewall,privacy --dry-run
          echo "✓ Category filtering works"

      - name: Severity filter test
        run: |
          echo "=== Severity Filter Test ==="
          python macos_security_audit.py --min-severity HIGH --dry-run
          # Exit codes 0, 2, 3 are valid (audit may find issues on runner)
          python macos_security_audit.py --min-severity CRITICAL --format json > /dev/null || exit_code=$?
          if [ "${exit_code:-0}" -eq 1 ]; then
            echo "ERROR: Script failed with exit code 1"
            exit 1
          fi
          echo "✓ Severity filtering works"

  # Summary job that reports overall status
  smoke-test-summary:
    name: Smoke Test Summary
    needs: smoke-test
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check smoke test results
        run: |
          if [ "${{ needs.smoke-test.result }}" == "success" ]; then
            echo "✅ All smoke tests passed!"
            exit 0
          else
            echo "❌ Some smoke tests failed"
            exit 1
          fi
